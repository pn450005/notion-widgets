<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pink Pixel Weather</title>
<style>
  :root{
    --bg:#1a1325;        /* dark pink background */
    --card:#221127;      /* card bg */
    --fg:#ffe7f3;        /* text */
    --muted:#f0a6c1;     /* secondary */
    --accent:#ff4d8d;    /* hot pink */
    --chip:#2a1630;      /* mini day bg */
  }
  body.sunrise{
    --bg:#fff0f6; --card:#ffe3ef; --fg:#5a1037; --muted:#b85a7e;
    --accent:#ff4d8d; --chip:#ffd9e7;
  }
  html,body{height:100%;margin:0}
  body{display:grid;place-items:center;background:var(--bg);color:var(--fg);
       font:600 16px/1.4 ui-sans-serif,system-ui,Segoe UI,Arial}
  .widget{background:var(--card);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.35);
          padding:18px 20px;min-width:290px;max-width:420px;width:92%}
  .top{display:flex;justify-content:space-between;align-items:center}
  .date{font-weight:800}
  .loc{color:var(--muted);font-weight:700}
  .now{display:flex;align-items:center;gap:14px;margin:12px 0 6px}
  .icon img{width:72px;height:72px;image-rendering:pixelated}
  .temp{font-size:44px;letter-spacing:.02em}
  .desc{color:var(--muted);margin-top:2px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .day{background:var(--chip);border-radius:12px;padding:10px;text-align:center}
  .hi{font-size:18px} .lo{color:var(--muted);font-size:12px}
  .tiny img{width:28px;height:28px;image-rendering:pixelated}

  /* cute toggle */
  .toggle{position:relative;display:inline-block;width:44px;height:24px}
  .toggle input{display:none}
  .slider{position:absolute;cursor:pointer;inset:0;background:#3a2746;border-radius:999px;transition:.2s}
  .slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:var(--accent);
    border-radius:50%;transition:.2s}
  input:checked + .slider{background:#ffd7e6}
  input:checked + .slider:before{transform:translateX(20px);background:#ff4d8d}
</style>

<div class="widget">
  <div class="top">
    <div>
      <div class="date" id="date">—</div>
      <div class="loc" id="loc">Loading…</div>
    </div>
    <label class="toggle" title="Toggle light/dark">
      <input id="theme" type="checkbox"><span class="slider"></span>
    </label>
  </div>

  <div class="now">
    <div class="icon" id="bigIcon" aria-hidden="true"></div>
    <div>
      <div class="temp" id="temp">--°</div>
      <div class="desc" id="desc">—</div>
    </div>
  </div>

  <div class="grid" id="grid"></div>
</div>

<script>
/* ===== URL options =====
   ?city=Stony%20Brook  OR  ?lat=40.925&lon=-73.140
   Optional: ?theme=sunrise  (light pink card)
*/
const qs=new URLSearchParams(location.search);
const city=qs.get('city'); const lat=qs.get('lat'); const lon=qs.get('lon');
if((qs.get('theme')||'').toLowerCase()==='sunrise') document.body.classList.add('sunrise');
theme.checked = document.body.classList.contains('sunrise');
theme.addEventListener('change',()=>document.body.classList.toggle('sunrise'));

date.textContent = new Date().toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric'});

/* ===== Pixel-art icon renderer (16x16 canvas → scaled) ===== */
function makeCanvas(size=16){ const c=document.createElement('canvas'); c.width=c.height=size; return c; }
const COL = {
  sun: '#ff4d8d',           // rays/bolt/accents
  sunCore: '#ff8fb6',       // sun core
  cloudDay: '#ffd1e6',
  cloudNight: '#ffb3cf',
  moon: '#ffd1e6',
  star: '#ffe3ef',
  rain: '#ff6ea6',
  snow: '#ffe3ef',
  fog:  '#ff9ec3'
};
function pset(ctx,x,y,color){ ctx.fillStyle=color; ctx.fillRect(x, y, 1, 1); }
function circle(ctx,cx,cy,r,color){
  for(let y=0;y<16;y++)for(let x=0;x<16;x++){
    const dx=x-cx, dy=y-cy; if(dx*dx+dy*dy<=r*r) pset(ctx,x,y,color);
  }
}
function line(ctx,x1,y1,x2,y2,color){ // Bresenham-ish
  x1|=0;y1|=0;x2|=0;y2|=0;
  const dx=Math.abs(x2-x1), sx=x1<x2?1:-1;
  const dy=-Math.abs(y2-y1), sy=y1<y2?1:-1;
  let err=dx+dy, x=x1, y=y1;
  while(true){ pset(ctx,x,y,color); if(x===x2 && y===y2) break;
    const e2=2*err; if(e2>=dy){ err+=dy; x+=sx; } if(e2<=dx){ err+=dx; y+=sy; } }
}
function renderIcon(kind){ // returns dataURL
  const c=makeCanvas(16), ctx=c.getContext('2d');
  const night = /Night$/.test(kind);
  const cloud = night ? COL.cloudNight : COL.cloudDay;

  if(kind==='ClearDay'){
    circle(ctx,8,8,4, COL.sunCore);
    // rays
    line(ctx,8,1,8,4,COL.sun);
    line(ctx,8,12,8,15,COL.sun);
    line(ctx,1,8,4,8,COL.sun);
    line(ctx,12,8,15,8,COL.sun);
    line(ctx,3,3,5,5,COL.sun);
    line(ctx,11,3,9,5,COL.sun);
    line(ctx,3,13,5,11,COL.sun);
    line(ctx,11,13,9,11,COL.sun);
  } else if(kind==='ClearNight'){
    circle(ctx,9,8,5, COL.moon);     // moon
    circle(ctx,11,8,5, 'rgba(0,0,0,0)'); // cutout (visual overlap hack below)
    // carve crescent by overdrawing with transparent not supported; draw bg-colored cut
    for(let y=0;y<16;y++)for(let x=0;x<16;x++){
      const dx=x-11, dy=y-8; if(dx*dx+dy*dy<=25) pset(ctx,x,y, 'rgba(0,0,0,0)');
    }
    // stars
    pset(ctx,3,3,COL.star); pset(ctx,12,4,COL.star); pset(ctx,6,13,COL.star);
  } else if(kind.includes('Cloudy')){
    circle(ctx,6,9,4, cloud);
    circle(ctx,10,9,5, cloud);
    circle(ctx,12,11,3, cloud);
  } else if(kind.includes('Rain')){
    circle(ctx,6,9,4, cloud); circle(ctx,10,9,5, cloud); circle(ctx,12,11,3, cloud);
    // raindrops
    line(ctx,5,13,5,15,COL.rain); line(ctx,8,13,8,15,COL.rain); line(ctx,11,13,11,15,COL.rain);
  } else if(kind.includes('Snow')){
    circle(ctx,6,9,4, cloud); circle(ctx,10,9,5, cloud); circle(ctx,12,11,3, cloud);
    // snow dots
    pset(ctx,5,14,COL.snow); pset(ctx,8,14,COL.snow); pset(ctx,11,14,COL.snow);
  } else if(kind.includes('Thunder')){
    circle(ctx,6,9,4, cloud); circle(ctx,10,9,5, cloud); circle(ctx,12,11,3, cloud);
    // bolt (zig-zag)
    line(ctx,8,10,6,14,COL.sun);
    line(ctx,6,14,9,14,COL.sun);
    line(ctx,9,14,7,15,COL.sun);
  } else if(kind.includes('Fog')){
    // low cloud band
    circle(ctx,7,10,5, cloud); circle(ctx,12,10,3, cloud);
    // fog lines
    line(ctx,2,6,14,6,COL.fog); line(ctx,1,13,15,13,COL.fog);
  }

  // night extras (stars) for cloudy/rain/snow/thunder/fog
  if(night && kind!=='ClearNight'){
    pset(ctx,2,3,COL.star); pset(ctx,13,5,COL.star);
  }

  return c.toDataURL(); // PNG data URL
}

/* small version for the 3-day preview (use day variants) */
function tiny(kind){ const img=new Image(); img.src=renderIcon(kind); img.width=28; img.height=28; img.style.imageRendering='pixelated'; return img; }

/* ===== Weather code → base group ===== */
function codeToGroup(code){
  if(code===0) return 'Clear';
  if([1,2,3].includes(code)) return 'Cloudy';
  if([45,48].includes(code)) return 'Fog';
  if((code>=51 && code<=67) || (code>=80 && code<=82)) return 'Rain';
  if((code>=71 && code<=77) || (code>=85 && code<=86)) return 'Snow';
  if(code===95 || code===96 || code===99) return 'Thunder';
  return 'Cloudy';
}

/* ===== Geocode + fetch ===== */
async function geocode(name){
  const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`;
  const r=await fetch(url); const j=await r.json();
  if(!j.results || !j.results[0]) throw new Error('Place not found');
  const g=j.results[0]; return {lat:g.latitude, lon:g.longitude, label:`${g.name}${g.admin1?', '+g.admin1:''}`};
}

async function load(){
  let where={lat:null,lon:null,label:''};
  if(lat && lon){ where={lat:+lat, lon:+lon, label: city || `${lat}, ${lon}`}; }
  else if(city){ where=await geocode(city); }
  else { where=await geocode('Stony Brook'); }  // default
  loc.textContent = where.label;

  // ask for is_day as well
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${where.lat}&longitude=${where.lon}`
            + `&current=temperature_2m,weather_code,is_day`
            + `&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto`;

  const r = await fetch(url); const data = await r.json();

  const t = Math.round(data.current.temperature_2m);
  const base = codeToGroup(data.current.weather_code);
  const isDay = data.current.is_day === 1;

  const kind = (base==='Clear')
      ? (isDay ? 'ClearDay' : 'ClearNight')
      : base + (isDay ? 'Day' : 'Night');

  temp.textContent = t + '°';
  const labelMap = {ClearDay:'Clear (Day)', ClearNight:'Clear (Night)'};
  desc.textContent = labelMap[kind] || base + (isDay ? '' : ' (Night)');

  // big pixel icon
  const img = new Image(); img.src = renderIcon(kind); img.style.imageRendering='pixelated';
  document.getElementById('bigIcon').innerHTML=''; document.getElementById('bigIcon').appendChild(img);

  // 3-day mini forecast (daily has no is_day → use day variants)
  grid.innerHTML='';
  for(let i=0;i<3;i++){
    const d = data.daily.time[i];
    const hi = Math.round(data.daily.temperature_2m_max[i]);
    const lo = Math.round(data.daily.temperature_2m_min[i]);
    const g  = codeToGroup(data.daily.weather_code[i]) + 'Day';
    const el = document.createElement('div'); el.className='day';
    const iconWrap = document.createElement('div'); iconWrap.className='tiny'; iconWrap.appendChild(tiny(g));
    el.appendChild(document.createElement('div')).textContent =
      new Date(d).toLocaleDateString(undefined,{weekday:'short'});
    el.appendChild(iconWrap);
    const hiEl=document.createElement('div'); hiEl.className='hi'; hiEl.textContent=hi+'°'; el.appendChild(hiEl);
    const loEl=document.createElement('div'); loEl.className='lo'; loEl.textContent=lo+'°'; el.appendChild(loEl);
    grid.appendChild(el);
  }
}

load().catch(err=>{
  loc.textContent='Weather'; temp.textContent='—'; desc.textContent=err.message||'Failed to load';
});
</script>

